<div class="page-container product-list-page">
  <!-- HEADER -->
  <div class="page-header">
    <div>
      <h2 class="page-title">
        <i class="bi bi-box-seam me-2"></i>
        Productos
      </h2>
      <p class="page-subtitle">
        Gestiona el cat√°logo de productos del Pepian.
      </p>
    </div>

    <div class="d-flex align-items-center gap-2">
      <span class="badge page-chip d-none d-md-inline-flex">
        {{ products.length }} √≠tem(s)
      </span>

      <button
        type="button"
        class="btn btn-outline-secondary btn-sm"
        (click)="loadProducts()"
        [disabled]="loading"
      >
        <i class="bi bi-arrow-clockwise me-1"></i>
        Actualizar
      </button>

      <button class="btn btn-primary btn-sm" (click)="goToNew()">
        <i class="bi bi-plus-circle me-1"></i>
        Nuevo producto
      </button>
    </div>
  </div>

  <!-- CARD PRINCIPAL -->
  <div class="page-card">
    <!-- Toolbar: buscador + info -->
    <div class="page-card-header">
      <div>
        <div class="page-card-title">
          <i class="bi bi-list-ul me-1"></i>
          Listado de productos
        </div>
        <div class="page-card-subtitle">
          {{ products.length }} producto(s) en total
          <span *ngIf="search" class="ms-1 text-muted">
            ‚Ä¢ Filtro: "{{ search }}"
          </span>
        </div>
      </div>

      <div class="page-toolbar">
        <div class="input-group input-group-sm">
          <span class="input-group-text">
            <i class="bi bi-search"></i>
          </span>
          <input
            type="text"
            class="form-control"
            placeholder="Buscar por nombre, SKU o categor√≠a"
            [(ngModel)]="search"
            (ngModelChange)="onSearchChange()"
          />
        </div>
      </div>
    </div>

    <!-- Estados -->
    <ng-container *ngIf="loading">
      <div class="text-center py-4">
        <div class="spinner-border spinner-border-sm" role="status"></div>
        <p class="text-muted mt-2 mb-0">Cargando productos...</p>
      </div>
    </ng-container>

    <div *ngIf="error" class="alert alert-danger mb-2">
      {{ error }}
    </div>

    <!-- Tabla -->
    <div class="table-responsive" *ngIf="!loading && !error">
      <table class="table page-table align-middle">
        <thead>
        <tr>
          <th style="width: 110px;">SKU</th>
          <th>Nombre</th>
          <th class="text-center" style="width: 100px;">Unidad</th>
          <th style="width: 160px;">Categor√≠a</th>
          <th class="text-center" style="width: 90px;">Stock</th>
          <th class="text-center" style="width: 110px;">Nivel stock</th>
          <th class="text-center" style="width: 110px;">Estado</th>
          <th class="text-end" style="width: 120px;">Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr
          *ngFor="let p of filtered"
          class="product-row"
          [ngClass]="{ 'product-row-inactive': !p.active }"
        >

        <td class="fw-semibold text-monospace">
            {{ p.sku }}
          </td>
          <td>
            <div class="fw-semibold mb-0">{{ p.name }}</div>
            <div class="small text-muted" *ngIf="p.description">
              {{ p.description }}
            </div>
          </td>
          <td class="text-center">
            <span class="badge bg-light text-muted" *ngIf="p.unit; else noUnit">
              {{ p.unit }}
            </span>
            <ng-template #noUnit>
              <span class="text-muted">‚Äî</span>
            </ng-template>
          </td>
          <td>
            <span *ngIf="p.category; else noCat" class="badge bg-soft-blue">
              <i class="bi bi-tag me-1"></i>
              {{ p.category }}
            </span>
            <ng-template #noCat>
              <span class="text-muted">Sin categor√≠a</span>
            </ng-template>
          </td>
          <td class="text-center">
            <span *ngIf="stockBySku[p.sku] !== undefined; else noStock">
              <span
                class="stock-chip"
                [ngClass]="{
                  'stock-chip-ok': (stockBySku[p.sku] || 0) > 5,
                  'stock-chip-low': (stockBySku[p.sku] || 0) > 0 && (stockBySku[p.sku] || 0) <= 5,
                  'stock-chip-zero': (stockBySku[p.sku] || 0) === 0
                }"
              >
                {{ stockBySku[p.sku] }}
              </span>
            </span>
            <ng-template #noStock>
              <span class="text-muted">STOK</span>
            </ng-template>
          </td>

          <!-- Nivel stock (usa tu stockLabel pero en badge) -->
          <td class="text-center">
            <span class="badge stock-status-badge">
              {{ stockLabel(p) }}
            </span>
          </td>

          <!-- Activo / Inactivo -->
          <td class="text-center">
            <span
              class="badge-status"
              [ngClass]="availabilityClass(p)"
            >
              <span
                class="status-dot me-1"
                [ngClass]="availabilityDotClass(p)"
              ></span>
              {{ availabilityLabel(p) }}
            </span>
          </td>


          <!-- Acciones -->
          <td>
            <div class="table-actions">
              <button
                class="btn btn-outline-secondary btn-sm"
                type="button"
                (click)="edit(p)"
              >
                <i class="bi bi-pencil"></i>
              </button>

            </div>
          </td>
        </tr>

        <tr *ngIf="!loading && filtered.length === 0">
          <td colspan="8" class="text-center text-muted py-4">
            <div class="empty-state">
              <div class="empty-icon mb-2">üì≠</div>
              <div class="fw-semibold mb-1">
                No se encontraron productos
              </div>
              <div class="small mb-2">
                Ajusta el t√©rmino de b√∫squeda o registra un nuevo producto.
              </div>
              <button
                type="button"
                class="btn btn-primary btn-sm"
                (click)="goToNew()"
              >
                <i class="bi bi-plus-circle me-1"></i>
                Registrar producto
              </button>
            </div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
