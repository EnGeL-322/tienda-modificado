<div class="page-container">
  <!-- HEADER -->
  <div class="page-header">
    <div>
      <h2 class="page-title">Compras</h2>
      <p class="page-subtitle">
        Historial de órdenes de compra realizadas al proveedor.
      </p>
    </div>

    <button class="btn btn-primary btn-sm" type="button" (click)="goToNew()">
      <i class="bi bi-plus-circle me-1"></i>
      Nueva compra
    </button>
  </div>

  <!-- CARD PRINCIPAL -->
  <div class="page-card">
    <!-- Toolbar: filtros -->
    <div class="page-card-header">
      <div>
        <div class="page-card-title">Listado</div>
        <div class="page-card-subtitle">
          {{ purchases.length }} compra(s) registradas.
        </div>
      </div>

      <div class="page-toolbar gap-2">
        <!-- Filtro por estado -->
        <select
          class="form-select form-select-sm w-auto"
          [(ngModel)]="statusFilter"
          (ngModelChange)="onStatusChange($event)"
        >
          <option value="">Todos los estados</option>
          <option value="PENDING">Pendientes</option>
          <option value="RECEIVED">Recibidas</option>
          <option value="CANCELLED">Canceladas</option>
        </select>

        <!-- Buscador -->
        <div class="input-group input-group-sm">
          <span class="input-group-text">
            <i class="bi bi-search"></i>
          </span>
          <input
            type="text"
            class="form-control"
            placeholder="Buscar por #orden o proveedor"
            [(ngModel)]="search"
            (ngModelChange)="onSearchChange()"
          />
        </div>
      </div>
    </div>

    <!-- Estados -->
    <ng-container *ngIf="loading">
      <div class="text-center py-4">
        <div class="spinner-border spinner-border-sm" role="status"></div>
        <p class="text-muted mt-2 mb-0">Cargando compras...</p>
      </div>
    </ng-container>

    <div *ngIf="error" class="alert alert-danger mb-2">
      {{ error }}
    </div>

    <!-- Tabla -->
    <div class="table-responsive" *ngIf="!loading && !error">
      <table class="table page-table align-middle">
        <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Proveedor</th>
          <th>Fecha creación</th>
          <th>Fecha recepción</th>
          <th>Estado</th>
          <th class="text-end">Unidades</th>
          <th class="text-end">Total S/.</th>
          <th class="text-end">Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let o of filtered">
          <td>{{ o.id }}</td>
          <td>{{ o.supplierName }}</td>
          <td>{{ o.createdAt | date : 'short' }}</td>
          <td>
        <span *ngIf="o.receivedAt; else pendiente">
          {{ o.receivedAt | date : 'short' }}
        </span>
            <ng-template #pendiente>
              <span class="badge text-bg-warning">Pendiente</span>
            </ng-template>
          </td>
          <td>
        <span
          class="badge"
          [ngClass]="{
            'text-bg-secondary': o.status === 'PENDING',
            'text-bg-success': o.status === 'RECEIVED',
            'text-bg-danger': o.status === 'CANCELLED'
          }"
        >
          {{ o.status }}
        </span>
          </td>
          <td class="text-end">
            {{ getOrderItemCount(o) }}
          </td>
          <td class="text-end">
            {{ getOrderTotal(o) | number : '1.2-2' }}
          </td>
          <td class="text-end">
            <button
              type="button"
              class="btn btn-sm btn-outline-primary"
              (click)="goToDetail(o)"
            >
              Ver
            </button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

  </div>
</div>
