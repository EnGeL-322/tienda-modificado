<div class="page-container">
  <!-- HEADER -->
  <div class="page-header">
    <div>
      <h2 class="page-title">Ventas</h2>
      <p class="page-subtitle">
        Consulta las ventas registradas y accede al detalle de cada una.
      </p>
    </div>

    <button class="btn btn-primary btn-sm" type="button" (click)="goToNew()">
      <i class="bi bi-plus-circle me-1"></i>
      Nueva venta
    </button>
  </div>

  <!-- CARD PRINCIPAL -->
  <div class="page-card">
    <!-- Toolbar: buscador + info -->
    <div class="page-card-header">
      <div>
        <div class="page-card-title">Listado de ventas</div>
        <div class="page-card-subtitle">
          {{ filtered.length }} venta(s) encontradas.
        </div>
      </div>

      <div class="page-toolbar">
        <div class="input-group input-group-sm">
          <span class="input-group-text">
            <i class="bi bi-search"></i>
          </span>
          <input
            type="text"
            class="form-control"
            placeholder="Buscar por cliente, estado o ID"
            [(ngModel)]="search"
            (ngModelChange)="onSearchChange()"
          />
        </div>
      </div>
    </div>

    <!-- Estados -->
    <ng-container *ngIf="loading">
      <div class="text-center py-4">
        <div class="spinner-border spinner-border-sm" role="status"></div>
        <p class="text-muted mt-2 mb-0">Cargando ventas...</p>
      </div>
    </ng-container>

    <div *ngIf="error" class="alert alert-danger mb-2">
      {{ error }}
    </div>

    <!-- Tabla -->
    <div class="table-responsive" *ngIf="!loading && !error">
      <table class="table page-table align-middle">
        <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Cliente</th>
          <th>Fecha</th>
          <th>Estado</th>
          <th class="text-end">Unidades</th>
          <th class="text-end">Total S/.</th>
          <th class="text-end">Acciones</th>
        </tr>
        </thead>
        <tbody>
        <!-- ðŸ‘‡ usamos filtered para respetar el buscador -->
        <tr *ngFor="let s of filtered">
          <td>{{ s.id }}</td>
          <td>{{ s.customerName }}</td>
          <td>{{ s.createdAt | date : 'short' }}</td>
          <td>
              <span
                class="badge"
                [ngClass]="{
                  'text-bg-secondary': s.status === 'PENDING',
                  'text-bg-success': s.status === 'COMPLETED',
                  'text-bg-danger': s.status === 'CANCELLED'
                }"
              >
                {{ s.status }}
              </span>
          </td>
          <td class="text-end">
            {{ getSaleItemCount(s) }}
          </td>
          <td class="text-end">
            {{ getSaleTotal(s) | number : '1.2-2' }}
          </td>
          <td class="text-end">
            <button
              class="btn btn-sm btn-outline-primary"
              type="button"
              (click)="goToDetail(s)"
            >
              Ver
            </button>
          </td>
        </tr>

        <tr *ngIf="!loading && !error && filtered.length === 0">
          <td colspan="7" class="text-center text-muted py-3">
            No se encontraron ventas con ese criterio.
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
