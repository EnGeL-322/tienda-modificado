<div class="dashboard-page">
  <!-- HEADER -->
  <div
    class="card shadow-sm border-0 mb-3 header-card d-flex flex-wrap justify-content-between align-items-center gap-2"
  >
    <div class="card-body p-3">
      <h2 class="h5 mb-1">Panel principal</h2>
      <p class="text-muted mb-0">
        Selecciona un m칩dulo desde el men칰 de la izquierda o desde estas
        tarjetas r치pidas.
      </p>
    </div>
  </div>

  <!-- TARJETAS DE ACCESO R츼PIDO -->
  <div class="row g-3 mb-3">
    <!-- Cat치logo -->
    <div class="col-sm-6 col-lg-3">
      <a routerLink="/catalogo/productos" class="text-decoration-none">
        <div class="card dashboard-card shadow-sm border-0 h-100">
          <div class="card-body">
            <div class="dashboard-icon catalogo mb-3">
              <span>游닍</span>
            </div>
            <h5 class="card-title mb-1">Cat치logo</h5>
            <p class="card-text text-muted mb-0">
              Gestiona los productos del hotel.
            </p>
          </div>
        </div>
      </a>
    </div>

    <!-- Inventario -->
    <div class="col-sm-6 col-lg-3">
      <a routerLink="/inventario" class="text-decoration-none">
        <div class="card dashboard-card shadow-sm border-0 h-100">
          <div class="card-body">
            <div class="dashboard-icon inventario mb-3">
              <span>游늵</span>
            </div>
            <h5 class="card-title mb-1">Inventario</h5>
            <p class="card-text text-muted mb-0">
              Consulta stock y movimientos.
            </p>
          </div>
        </div>
      </a>
    </div>

    <!-- Compras -->
    <div class="col-sm-6 col-lg-3">
      <a routerLink="/compras" class="text-decoration-none">
        <div class="card dashboard-card shadow-sm border-0 h-100">
          <div class="card-body">
            <div class="dashboard-icon compras mb-3">
              <span>游</span>
            </div>
            <h5 class="card-title mb-1">Compras</h5>
            <p class="card-text text-muted mb-0">
              Registra nuevas 칩rdenes de compra.
            </p>
          </div>
        </div>
      </a>
    </div>

    <!-- Ventas -->
    <div class="col-sm-6 col-lg-3">
      <a routerLink="/ventas" class="text-decoration-none">
        <div class="card dashboard-card shadow-sm border-0 h-100">
          <div class="card-body">
            <div class="dashboard-icon ventas mb-3">
              <span>游눱</span>
            </div>
            <h5 class="card-title mb-1">Ventas</h5>
            <p class="card-text text-muted mb-0">
              Registra ventas con carrito.
            </p>
          </div>
        </div>
      </a>
    </div>
  </div>

  <!-- ESTAD칈STICAS R츼PIDAS -->
  <div class="card shadow-sm border-0 mb-3">
    <div class="card-body p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <h5 class="h6 mb-1">Resumen de compras y ventas</h5>
          <p class="text-muted small mb-0">
            C치lculo estimado en base a las 칩rdenes de compra y ventas
            registradas.
          </p>
        </div>

        <div *ngIf="loadingSales" class="text-muted small">
          <span class="spinner-border spinner-border-sm me-1"></span>
          Cargando estad칤sticas...
        </div>
      </div>

      <div *ngIf="salesError" class="alert alert-danger py-2 mb-3">
        {{ salesError }}
      </div>

      <div *ngIf="!salesError">
        <!-- KPIs -->
        <div class="row g-3 mb-3">
          <div class="col-sm-6 col-lg-3">
            <div class="border rounded p-3 bg-light h-100">
              <div class="text-muted small">Ventas registradas</div>
              <div class="fs-4 fw-semibold">
                {{ totalSalesCount }}
              </div>
            </div>
          </div>

          <div class="col-sm-6 col-lg-3">
            <div class="border rounded p-3 bg-light h-100">
              <div class="text-muted small">Total vendido (S/.)</div>
              <div class="fs-4 fw-semibold">
                {{ totalSalesAmount | number : '1.2-2' }}
              </div>
            </div>
          </div>

          <div class="col-sm-6 col-lg-3">
            <div class="border rounded p-3 bg-light h-100">
              <div class="text-muted small">Total comprado (S/.)</div>
              <div class="fs-4 fw-semibold">
                {{ totalPurchasesAmount | number : '1.2-2' }}
              </div>
            </div>
          </div>

          <div class="col-sm-6 col-lg-3">
            <div class="border rounded p-3 bg-light h-100">
              <div class="text-muted small">Utilidad estimada (S/.)</div>
              <div
                class="fs-4 fw-semibold"
                [ngClass]="estimatedProfit >= 0 ? 'text-success' : 'text-danger'"
              >
                {{ estimatedProfit | number : '1.2-2' }}
              </div>
              <div class="text-muted small">
                Ventas - costo estimado de lo vendido
              </div>
            </div>
          </div>
        </div>

        <!-- NUEVO: GR츼FICOS R츼PIDOS (BARRAS + PASTEL) -->
        <div
          class="row g-3 mb-3"
          *ngIf="totalSalesAmount > 0 || totalPurchasesAmount > 0"
        >
          <!-- Barras KPI -->
          <div class="col-md-6">
            <div class="border rounded p-3 h-100">
              <h6 class="mb-2">Distribuci칩n de KPIs</h6>
              <p class="text-muted small mb-2">
                Comparativo de ventas, compras y utilidad.
              </p>

              <div class="kpi-bar mb-2">
                <div
                  class="d-flex justify-content-between align-items-center small mb-1"
                >
                  <span>Ventas</span>
                  <span>
                    {{ totalSalesAmount | number : '1.2-2' }} ({{ getKpiPercent('sales') | number : '1.0-1' }}%)
                  </span>
                </div>
                <div class="chart-bar-bg">
                  <div
                    class="chart-bar-fill bg-success"
                    [style.width.%]="getKpiPercent('sales')"
                  ></div>
                </div>
              </div>

              <div class="kpi-bar mb-2">
                <div
                  class="d-flex justify-content-between align-items-center small mb-1"
                >
                  <span>Compras</span>
                  <span>
                    {{ totalPurchasesAmount | number : '1.2-2' }} ({{ getKpiPercent('purchases') | number : '1.0-1' }}%)
                  </span>
                </div>
                <div class="chart-bar-bg">
                  <div
                    class="chart-bar-fill bg-primary"
                    [style.width.%]="getKpiPercent('purchases')"
                  ></div>
                </div>
              </div>

              <div class="kpi-bar">
                <div
                  class="d-flex justify-content-between align-items-center small mb-1"
                >
                  <span>Utilidad</span>
                  <span>
                    {{ estimatedProfit | number : '1.2-2' }} ({{ getKpiPercent('profit') | number : '1.0-1' }}%)
                  </span>
                </div>
                <div class="chart-bar-bg">
                  <div
                    class="chart-bar-fill"
                    [ngClass]="estimatedProfit >= 0 ? 'bg-success' : 'bg-danger'"
                    [style.width.%]="getKpiPercent('profit')"
                  ></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Pastel Ventas vs Compras -->
          <div class="col-md-6">
            <div class="border rounded p-3 h-100">
              <h6 class="mb-2">Ventas vs Compras</h6>
              <p class="text-muted small mb-2">
                Proporci칩n de ventas frente a compras.
              </p>

              <div
                *ngIf="totalSalesAmount > 0 || totalPurchasesAmount > 0; else noPieData"
                class="d-flex align-items-center gap-3"
              >
                <!-- c칤rculo tipo pastel -->
                <div
                  class="pie-chart"
                  [style.background]="getSalesPurchasePieBackground()"
                ></div>

                <!-- leyenda -->
                <ul class="list-unstyled small mb-0">
                  <li class="mb-1 d-flex align-items-center">
                    <span class="legend-dot legend-sales me-2"></span>
                    <span>
                      Ventas:
                      {{ totalSalesAmount | number : '1.2-2' }}
                    </span>
                  </li>
                  <li class="mb-1 d-flex align-items-center">
                    <span class="legend-dot legend-purchases me-2"></span>
                    <span>
                      Compras:
                      {{ totalPurchasesAmount | number : '1.2-2' }}
                    </span>
                  </li>
                </ul>
              </div>

              <ng-template #noPieData>
                <div class="text-muted small">
                  A칰n no hay datos suficientes para mostrar el gr치fico.
                </div>
              </ng-template>
            </div>
          </div>
        </div>
        <!-- FIN NUEVO -->

        <!-- TOPS -->
        <div class="row g-3 mb-3">
          <!-- Top productos -->
          <div class="col-md-6">
            <div class="border rounded p-3 h-100">
              <h6 class="mb-2">Top productos vendidos</h6>
              <p class="text-muted small mb-2">Por unidades (top 5).</p>

              <div *ngIf="topProducts.length === 0" class="text-muted small">
                No hay productos para mostrar.
              </div>

              <table
                *ngIf="topProducts.length > 0"
                class="table table-sm mb-0 align-middle"
              >
                <thead>
                <tr>
                  <th>Producto</th>
                  <th class="text-end">Unidades</th>
                  <th class="text-end">Total S/.</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let p of topProducts">
                  <td>
                    <div class="fw-semibold">
                      {{ p.name || '(sin nombre)' }}
                    </div>
                    <div class="text-muted small">
                      {{ p.sku }}
                    </div>
                  </td>
                  <td class="text-end">{{ p.totalUnits }}</td>
                  <td class="text-end">
                    {{ p.totalAmount | number : '1.2-2' }}
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Top clientes -->
          <div class="col-md-6">
            <div class="border rounded p-3 h-100">
              <h6 class="mb-2">Top clientes</h6>
              <p class="text-muted small mb-2">
                Por monto total comprado (top 5).
              </p>

              <div *ngIf="topCustomers.length === 0" class="text-muted small">
                No hay clientes para mostrar.
              </div>

              <table
                *ngIf="topCustomers.length > 0"
                class="table table-sm mb-0 align-middle"
              >
                <thead>
                <tr>
                  <th>Cliente</th>
                  <th class="text-end">Ventas</th>
                  <th class="text-end">Total S/.</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let c of topCustomers">
                  <td>
                    <div class="fw-semibold">{{ c.name }}</div>
                    <div class="text-muted small" *ngIf="c.dni">
                      DNI: {{ c.dni }}
                    </div>
                  </td>
                  <td class="text-end">{{ c.salesCount }}</td>
                  <td class="text-end">
                    {{ c.totalAmount | number : '1.2-2' }}
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- COMPARATIVO COMPRAS VS VENTAS POR PRODUCTO -->
        <div class="border rounded p-3 mt-3">
          <h6 class="mb-2">Compras vs ventas por producto</h6>
          <p class="text-muted small mb-2">
            Costos estimados usando promedio de compra por SKU (solo
            referencia, no es un libro contable oficial).
          </p>

          <div *ngIf="productComparative.length === 0" class="text-muted small">
            No hay datos suficientes para mostrar el comparativo.
          </div>

          <div
            *ngIf="productComparative.length > 0"
            class="table-responsive"
          >
            <table class="table table-sm mb-0 align-middle">
              <thead>
              <tr>
                <th>Producto</th>
                <th class="text-end">Unid. compradas</th>
                <th class="text-end">Costo compras S/.</th>
                <th class="text-end">Unid. vendidas</th>
                <th class="text-end">Ingresos S/.</th>
                <th class="text-end">Costo vendido S/.</th>
                <th class="text-end">Utilidad S/.</th>
                <th class="text-end">Margen %</th>
              </tr>
              </thead>
              <tbody>
              <tr *ngFor="let p of productComparative">
                <td style="min-width: 200px">
                  <div class="fw-semibold">
                    {{ p.name || '(sin nombre)' }}
                  </div>
                  <div class="text-muted small">
                    {{ p.sku }}
                  </div>
                  <!-- mini barra seg칰n unidades vendidas -->
                  <div class="progress mt-1" style="height: 4px;">
                    <div
                      class="progress-bar"
                      role="progressbar"
                      [style.width.%]="maxUnitsSold > 0 ? (p.unitsSold / maxUnitsSold) * 100 : 0"
                      aria-valuemin="0"
                      [attr.aria-valuenow]="p.unitsSold"
                    ></div>
                  </div>
                </td>
                <td class="text-end">{{ p.unitsPurchased }}</td>
                <td class="text-end">
                  {{ p.costPurchased | number : '1.2-2' }}
                </td>
                <td class="text-end">{{ p.unitsSold }}</td>
                <td class="text-end">
                  {{ p.revenue | number : '1.2-2' }}
                </td>
                <td class="text-end">
                  {{ p.costOfSold | number : '1.2-2' }}
                </td>
                <td
                  class="text-end"
                  [ngClass]="p.profit >= 0 ? 'text-success' : 'text-danger'"
                >
                  {{ p.profit | number : '1.2-2' }}
                </td>
                <td
                  class="text-end"
                  [ngClass]="p.marginPct >= 0 ? 'text-success' : 'text-danger'"
                >
                  {{ p.marginPct | number : '1.0-1' }}%
                </td>
              </tr>
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>
